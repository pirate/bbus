name: test-py
permissions:
  actions: read
  contents: write
  pull-requests: write  # Allow writing comments on PRs
  issues: write         # Allow writing comments on issues
  statuses: write       # Allow writing statuses on PRs
  discussions: write

on:
  push:
    branches:
      - main
      - stable
      - 'releases/**'
    tags:
      - '*'
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          activate-environment: true

      - run: uv sync --dev --all-extras
      - run: uv run ruff format --check
      - run: uv run ruff check
      - run: uv run pyright

  find_tests:
    runs-on: ubuntu-latest
    outputs:
      PY_TASKS: ${{ steps.lsgrep.outputs.PY_TASKS }}
      # [{ "kind": "test" | "example", "name": "test_eventbus" }, ...]
      PY_TEST_TASKS: ${{ steps.lsgrep.outputs.PY_TEST_TASKS }}
      # [{ "kind": "test", "name": "test_eventbus" }, ...]
    steps:
      - uses: actions/checkout@v4
      - id: lsgrep
        run: |
          PY_TEST_TASKS="$(
            find tests -maxdepth 1 -type f -name 'test_*.py' \
              | sort \
              | sed 's|^tests/||' \
              | sed 's|\.py$||' \
              | jq -R -s -c 'split("\n")[:-1] | map({kind: "test", name: .})'
          )"
          PY_EXAMPLE_TASKS="$(
            (
              if [[ -d examples ]]; then
                find examples -maxdepth 1 -type f -name '*.py' | sort
              fi
            ) \
              | sed 's|^examples/||' \
              | sed 's|\.py$||' \
              | jq -R -s -c 'split("\n")[:-1] | map({kind: "example", name: .})'
          )"
          PY_TASKS="$(jq -cn --argjson tests "$PY_TEST_TASKS" --argjson examples "$PY_EXAMPLE_TASKS" '$tests + $examples')"

          echo "PY_TEST_TASKS=${PY_TEST_TASKS}" >> "$GITHUB_OUTPUT"
          echo "PY_TASKS=${PY_TASKS}" >> "$GITHUB_OUTPUT"
          echo "$PY_TASKS"
        # https://code.dblock.org/2021/09/03/generating-task-matrix-by-looping-over-repo-files-with-github-actions.html
      - name: Check that at least one test file is found
        run: |
          if [[ -z "${{ steps.lsgrep.outputs.PY_TEST_TASKS }}" || "${{ steps.lsgrep.outputs.PY_TEST_TASKS }}" == "[]" ]]; then
            echo "Failed to find any test_*.py files in tests/ folder!" > /dev/stderr
            exit 1
          fi

  tests:
    needs:
      - lint
      - find_tests
    runs-on: ubuntu-latest
    env:
      IN_DOCKER: 'True'
    strategy:
      matrix:
        task: ${{ fromJson(needs.find_tests.outputs.PY_TASKS || '[{"kind":"error","name":"FAILED_TO_DISCOVER_TASKS"}]') }}
        # autodiscovers files in tests/test_*.py and examples/*.py
        # - { kind: "test", name: "test_eventbus" }
        # - { kind: "example", name: "quickstart" }
        # ... and more
    name: ${{ matrix.task.kind }}-${{ matrix.task.name }}
    steps:
      - name: Check that the previous step managed to find some tasks for us to run
        run: |
          if [[ "${{ matrix.task.kind }}" == "error" ]]; then
            echo "Failed get list of tasks in tests/test_*.py and examples/*.py from find_tests job" > /dev/stderr
            exit 1
          fi

      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          activate-environment: true

      - run: uv sync --dev --all-extras

      - name: Run test with coverage
        if: matrix.task.kind == 'test'
        run: pytest -x tests/${{ matrix.task.name }}.py --cov=bubus --cov-report=term

      - name: Run example
        if: matrix.task.kind == 'example'
        run: uv run python examples/${{ matrix.task.name }}.py

      - name: Check coverage files
        if: matrix.task.kind == 'test'
        run: |
          echo "Looking for coverage files..."
          ls -la .coverage* 2>/dev/null || ls -la | grep coverage || echo "No coverage files found"
          if [ -f .coverage ]; then
            echo "Found .coverage file, size: $(stat -f%z .coverage 2>/dev/null || stat -c%s .coverage) bytes"
          fi

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.task.name }}
          path: |
            .coverage
            pyproject.toml
          retention-days: 7
          include-hidden-files: true
        if: matrix.task.kind == 'test' && always()

  coverage:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          activate-environment: true

      - run: uv sync --dev --all-extras

      - name: Download all coverage data
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-data/

      - name: Combine coverage data
        run: |
          # Find all .coverage files and copy them with unique names
          counter=1
          for coverage_file in $(find coverage-data -name ".coverage" -type f); do
            cp "$coverage_file" ".coverage.$counter"
            counter=$((counter + 1))
          done

      - name: Combine coverage & fail if it's <50%
        run: |
          uv tool install 'coverage[toml]'

          coverage combine
          coverage html --skip-covered --skip-empty

          echo "### Python combined coverage" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          # Report and write a markdown table to summary.
          coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "[Download HTML coverage artifact (coverage-report)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> "$GITHUB_STEP_SUMMARY"

          # Report again and fail if under 50%.
          coverage report --fail-under=50

      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
            pyproject.toml
          retention-days: 7

  perf:
    needs: coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          activate-environment: true

      - run: uv sync --dev --all-extras
      - run: uv run perf
